<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ë¦´ìŠ¤ì»µ íˆ¬í‘œ ì‹œìŠ¤í…œ</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box }
    body { font-family:'Arial',sans-serif; background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); min-height:100vh; color:#333 }
    .login-modal, .admin-login-modal {
      position:fixed; top:0; left:0; width:100%; height:100%;
      background:rgba(0,0,0,0.5); display:flex; align-items:center; justify-content:center;
    }
    .login-content {
      background:#fff; padding:30px; border-radius:15px; width:90%; max-width:400px; text-align:center;
    }
    .login-content h2 { margin-bottom:20px; color:#333 }
    .login-input { width:100%; padding:12px; margin:10px 0; border:1px solid #ddd; border-radius:8px; font-size:1em }
    .login-btn {
      background:#667eea; color:#fff; padding:12px 25px;
      border:none; border-radius:8px; cursor:pointer; font-size:1em; margin:10px 5px
    }
    .login-btn:hover { background:#5a6fd8 }
    .login-btn.cancel { background:#6c757d }
    .login-btn.cancel:hover { background:#5a6268 }
    .container { max-width:1200px; margin:50px auto; padding:20px; background:rgba(255,255,255,0.9); border-radius:15px }
    .header { text-align:center; margin-bottom:30px }
    .header h1 { font-size:2.5em; color:#333 }
    .vote-counter { text-align:center; font-size:1.2em; margin-bottom:20px }
    .reels-grid {
      display:grid; grid-template-columns:repeat(auto-fill,minmax(300px,1fr)); gap:20px; margin-bottom:30px
    }
    .reel-card {
      background:#fff; border-radius:15px; padding:20px; box-shadow:0 8px 32px rgba(0,0,0,0.1);
      display:flex; flex-direction:column; align-items:center
    }
    .reel-nickname { font-size:1.1em; color:#667eea; margin-bottom:12px; font-weight:bold; }
    .reel-video { width:100%; height:300px; border:none; border-radius:10px; margin-bottom:15px }
    .caption-section { width:100%; margin-bottom:15px }
    .reel-caption {
      white-space:pre-wrap; background:rgba(102,126,234,0.1); padding:10px; border-radius:8px; margin-bottom:10px
    }
    .caption-edit textarea {
      width:100%; padding:10px; border:1px solid #ddd; border-radius:5px; resize:vertical; font-size:1em
    }
    .caption-buttons { display:flex; gap:10px; margin-bottom:15px }
    .caption-buttons button {
      flex:1; padding:8px 12px; border:none; border-radius:5px; cursor:pointer; font-size:.9em
    }
    .edit-btn { background:#6c757d; color:#fff }
    .save-btn { background:#28a745; color:#fff }
    .cancel-btn { background:#dc3545; color:#fff }
    .vote-btn {
      width:100%; padding:12px; background:linear-gradient(135deg,#667eea,#764ba2);
      color:#fff; border:none; border-radius:8px; cursor:pointer; font-size:1em; font-weight:bold
    }
    .vote-btn.selected { background:linear-gradient(135deg,#4CAF50,#45a049) }
    .vote-btn:disabled { background:#ccc; cursor:not-allowed }
    .results-section { margin-top:30px }
    .results-section h2 {
      margin-bottom:20px; color:#333; border-bottom:2px solid #667eea; padding-bottom:10px
    }
    .result-item {
      display:flex; justify-content:space-between; padding:15px; margin-bottom:10px;
      background:rgba(102,126,234,0.1); border-radius:8px
    }
    .result-rank { font-size:1.2em; font-weight:bold; color:#667eea }
    .result-info { margin-left:10px; color:#333 }
    .result-votes { font-weight:bold; color:#333 }
    .final-results { display:none; margin-top:30px; text-align:center }
    .final-results h2 { margin-bottom:20px; font-size:2em; color:#333 }
    .winner {
      margin:10px 0; padding:15px; background:rgba(102,126,234,0.2); border-radius:10px; font-size:1.2em
    }
    .admin-controls { text-align:center; margin-bottom:30px }
    .admin-btn, .admin-btn.danger {
      padding:12px 20px; margin:0 5px; border:none; border-radius:8px; cursor:pointer; color:#fff
    }
    .admin-btn { background:#764ba2 }
    .admin-btn.danger { background:#dc3545 }
    .admin-btn:hover { opacity:.9 }
    .save-section { text-align:center; margin-top:20px }
    .status-text { margin-left:12px; font-size:.9em; color:#333 }
  </style>
</head>
<body>

  <!-- ì‚¬ìš©ì ë¡œê·¸ì¸ ëª¨ë‹¬ -->
  <div id="userLoginModal" class="login-modal">
    <div class="login-content">
      <h2>ë¦´ìŠ¤ì»µ ì‚¬ìš©ì ë¡œê·¸ì¸</h2>
      <input id="userName" class="login-input" type="text" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”">
      <button id="userLoginBtn" class="login-btn">ì…ì¥í•˜ê¸°</button>
    </div>
  </div>

  <!-- ë©”ì¸ ì»¨í…Œì´ë„ˆ -->
  <div class="container" id="appContainer" style="display:none;">
    <div class="header">
      <h1>ğŸ† ë¦´ìŠ¤ì»µ íˆ¬í‘œ ì‹œìŠ¤í…œ</h1>
      <p>ìµœëŒ€ 5í‘œê¹Œì§€ íˆ¬í‘œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
    </div>

    <div class="vote-counter">
      <span id="voteCount">0</span> / 5 ì„ íƒ ì™„ë£Œ
    </div>

    <div class="admin-controls">
      <button class="admin-btn" onclick="showFinalResults()">ìµœì¢… ê²°ê³¼ ë³´ê¸°</button>
      <button class="admin-btn" onclick="showAdminLogin()">ê´€ë¦¬ì ë¡œê·¸ì¸</button>
      <button class="admin-btn danger" id="clearVotesBtn" style="display:none;" onclick="clearAllVotes()">ëª¨ë“  íˆ¬í‘œ ì´ˆê¸°í™”</button>
      <button class="admin-btn" id="logoutAdminBtn" style="display:none;" onclick="logoutAdmin()">ê´€ë¦¬ì ë¡œê·¸ì•„ì›ƒ</button>
    </div>

    <div class="reels-grid" id="reelsGrid"></div>

    <div class="save-section">
      <button id="saveVotesBtn" class="login-btn">ì„ íƒí•œ íˆ¬í‘œ ì €ì¥</button>
      <span id="saveStatus" class="status-text"></span>
    </div>

    <div class="results-section">
      <h2>ğŸ“Š ì‹¤ì‹œê°„ íˆ¬í‘œ ê²°ê³¼</h2>
      <div id="resultsContainer"><p>ì•„ì§ íˆ¬í‘œê°€ ì—†ìŠµë‹ˆë‹¤.</p></div>
    </div>

    <div class="final-results" id="finalResults">
      <h2>ğŸ‰ ìµœì¢… ìš°ìŠ¹ì TOP 5</h2>
      <div id="winnersContainer"></div>
    </div>
  </div>

  <!-- ê´€ë¦¬ì ë¡œê·¸ì¸ ëª¨ë‹¬ -->
  <div id="adminLoginModal" class="admin-login-modal" style="display:none;">
    <div class="login-content">
      <h2>ğŸ” ê´€ë¦¬ì ë¡œê·¸ì¸</h2>
      <input id="adminId" class="login-input" type="text" placeholder="ì•„ì´ë””">
      <input id="adminPw" class="login-input" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸">
      <button id="adminLoginBtn" class="login-btn">ë¡œê·¸ì¸</button>
      <button id="adminCancelBtn" class="login-btn cancel">ì·¨ì†Œ</button>
    </div>
  </div>

  <!-- Firebase & ë¡œì§ -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
    import {
      getDatabase,
      ref,
      onValue,
      set,
      runTransaction
    } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-database.js";

    // Firebase ì„¤ì •
    const firebaseConfig = {
      apiKey: "AIzaSyBmxLEvOtqHqSyAUXtdYWlywvP1wgsQ_yk",
      authDomain: "reels-8708b.firebaseapp.com",
      projectId: "reels-8708b",
      storageBucket: "reels-8708b.firebasestorage.app",
      messagingSenderId: "614276576588",
      appId: "1:614276576588:web:1fab02cbc30615e69f0be9"
    };
    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);

    // ë°ì´í„° ì •ì˜
    const reelsData = [
      { id:1, url:'https://www.youtube.com/embed/-8dDe_EbKEk', nickname:'í˜¸ë¡¤ë¡¤ë¡œ', caption:'ì²« ë²ˆì§¸ ë¦´ìŠ¤\nì¤„ë„˜ê¹€ í…ŒìŠ¤íŠ¸' },
      { id:2, url:'https://www.youtube.com/embed/yahAVfaT5zs', nickname:'í•‘í•‘', caption:'ë‘ ë²ˆì§¸ ë¦´ìŠ¤\nì¤„ë„˜ê¹€ í…ŒìŠ¤íŠ¸' },
      { id:3, url:'https://www.youtube.com/embed/hNtdL1RtyQY', nickname:'ìœ¼ì•…', caption:'ì„¸ ë²ˆì§¸ ë¦´ìŠ¤\nì¤„ë„˜ê¹€ í…ŒìŠ¤íŠ¸' },
      { id:4, url:'https://www.youtube.com/embed/RtWbEDm4GvQ', nickname:'ë„ìš°ë„ˆ', caption:'ë„¤ ë²ˆì§¸ ë¦´ìŠ¤\nì¤„ë„˜ê¹€ í…ŒìŠ¤íŠ¸' },
      { id:5, url:'https://www.youtube.com/embed/ZNFc-2Bk86g', nickname:'í”Œë˜ë‹›ì„±í˜•ì™¸ê³¼ì˜ì›', caption:'ë‹¤ì„¯ ë²ˆì§¸ ë¦´ìŠ¤\nì¤„ë„˜ê¹€ í…ŒìŠ¤íŠ¸' },
      { id:6, url:'https://www.youtube.com/embed/VCStJdILfwQ', nickname:'í˜¸ë¡œë¡¤ë¡¤ë¡œ', caption:'ì—¬ì„¯ ë²ˆì§¸ ë¦´ìŠ¤\nì¤„ë„˜ê¹€ í…ŒìŠ¤íŠ¸' },
      { id:7, url:'https://www.youtube.com/embed/j5jRH9u583w', nickname:'í‚¤í‚¤', caption:'ì¼ê³± ë²ˆì§¸ ë¦´ìŠ¤\nì¤„ë„˜ê¹€ í…ŒìŠ¤íŠ¸' },
      { id:8, url:'https://www.youtube.com/embed/fBfsdIgHW0Q', nickname:'ì•„ì´ê³ ì•„ì´ê³ ', caption:'ì—¬ëŸ ë²ˆì§¸ ë¦´ìŠ¤\nì¤„ë„˜ê¹€ í…ŒìŠ¤íŠ¸' },
      { id:9, url:'https://www.youtube.com/embed/GEOQGCJilYI', nickname:'ë¼ì„', caption:'ì•„í™‰ ë²ˆì§¸ ë¦´ìŠ¤\nì¤„ë„˜ê¹€ í…ŒìŠ¤íŠ¸' },
      { id:10,url:'https://www.youtube.com/embed/RY60ZC9QyF8', nickname:'íí', caption:'ì—´ ë²ˆì§¸ ë¦´ìŠ¤\nì¤„ë„˜ê¹€ í…ŒìŠ¤íŠ¸' },
      { id:11,url:'https://www.youtube.com/embed/0Luy2181QMQ', nickname:'ì‚¡', caption:'ì—´í•œ ë²ˆì§¸ ë¦´ìŠ¤\nì¤„ë„˜ê¹€ í…ŒìŠ¤íŠ¸' },
      { id:12,url:'https://www.youtube.com/embed/8VDydtUJV5s', nickname:'í›Œë„ë¼', caption:'ì—´ë‘ ë²ˆì§¸ ë¦´ìŠ¤\nì¤„ë„˜ê¹€ í…ŒìŠ¤íŠ¸' },
      { id:13,url:'https://www.youtube.com/embed/fDaON3vG4uI', nickname:'ê¸¸êµ¬ëª½êµ¬ë´‰êµ¬', caption:'ì—´ì„¸ ë²ˆì§¸ ë¦´ìŠ¤\nì¤„ë„˜ê¹€ í…ŒìŠ¤íŠ¸' },
      { id:14,url:'https://www.youtube.com/embed/_qCY3j2RLgs', nickname:'ë–¡ìˆœì´', caption:'ì—´ë„¤ ë²ˆì§¸ ë¦´ìŠ¤\nì¤„ë„˜ê¹€ í…ŒìŠ¤íŠ¸' },
      { id:15,url:'https://www.youtube.com/embed/RyVTjCFWHlU', nickname:'ì¥¬ë¼ê¸°', caption:'ì—´ë‹¤ì„¯ ë²ˆì§¸ ë¦´ìŠ¤\nì¤„ë„˜ê¹€ í…ŒìŠ¤íŠ¸' }
    ];
    let votes = {}, userVotes = new Set(), currentUser = null, isAdmin = false;
    const MAX_VOTES=5, ADMIN_ID='admin', ADMIN_PW='4321';
    reelsData.forEach(r=>votes[r.id]=0);

    // DOM ì°¸ì¡°
    const userLoginModal = document.getElementById('userLoginModal');
    const appContainer    = document.getElementById('appContainer');
    const reelsGrid       = document.getElementById('reelsGrid');
    const voteCount       = document.getElementById('voteCount');
    const saveBtn         = document.getElementById('saveVotesBtn');
    const saveStatus      = document.getElementById('saveStatus');
    const resultsContainer= document.getElementById('resultsContainer');

    // ì‚¬ìš©ì ë¡œê·¸ì¸
    document.getElementById('userLoginBtn').onclick = () => {
      const name = document.getElementById('userName').value.trim();
      if (!name) return alert('ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      currentUser = name;
      userLoginModal.style.display='none';
      appContainer.style.display='block';
      subscribeRealtime();
      renderReels();
    };

    // Firebase êµ¬ë…
    function subscribeRealtime() {
      // ìº¡ì…˜Â·íˆ¬í‘œ ìˆ˜ ì‹¤ì‹œê°„ ë°˜ì˜
      reelsData.forEach(r => {
        onValue(ref(db, `captions/${r.id}`), snap => {
          if (snap.exists()) r.caption = snap.val();
          const el = document.getElementById(`caption-${r.id}`);
          if (el) el.textContent = r.caption;
        });
        onValue(ref(db, `votes/${r.id}`), snap => {
          votes[r.id] = snap.val()||0;
          updateResults();
        });
      });
      // ì´ˆê¸° ìƒíƒœ ë°˜ì˜
      updateResults();
    }

    // ë Œë”ë§
    function renderReels() {
      reelsGrid.innerHTML = reelsData.map(r=>`
        <div class="reel-card" id="card-${r.id}">
          <div class="reel-nickname">${r.nickname}</div>
          <iframe class="reel-video" src="${r.url}" allowfullscreen></iframe>
          <div class="caption-section">
            <div class="reel-caption" id="caption-${r.id}">${r.caption}</div>
          </div>
          <button class="vote-btn ${userVotes.has(r.id)?'selected':''}"
                  onclick="toggleSelect(${r.id})">
            ${userVotes.has(r.id)?'âœ“ ì„ íƒë¨':'ğŸ‘ ì„ íƒ'}
          </button>
        </div>
      `).join('');
      voteCount.textContent = userVotes.size;
    }

    // ì„ íƒ í† ê¸€ (ì €ì¥ ì „)
    window.toggleSelect = id => {
      if (userVotes.has(id)) {
        userVotes.delete(id);
      } else {
        if (userVotes.size >= MAX_VOTES) {
          return alert(`ìµœëŒ€ ${MAX_VOTES}ê°œê¹Œì§€ë§Œ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`);
        }
        userVotes.add(id);
      }
      renderReels();
    };

    // ì €ì¥ ë²„íŠ¼
    saveBtn.onclick = () => {
      if (!currentUser) return;
      saveBtn.disabled = true;
      saveStatus.textContent = 'ì €ì¥ ì¤‘â€¦';

      // payload ìƒì„±
      const payload = {};
      userVotes.forEach(id => payload[id] = true);

      // userVotes ì €ì¥
      set(ref(db, `userVotes/${currentUser}`), payload)
        .then(() => {
          // íˆ¬í‘œ ìˆ˜ë°˜ì˜
          userVotes.forEach(id => {
            runTransaction(ref(db, `votes/${id}`), v => (v||0)+1);
          });
          saveStatus.textContent = 'ì €ì¥ ì™„ë£Œ!';
        })
        .catch(err => {
          saveStatus.textContent = 'ì €ì¥ ì‹¤íŒ¨: ' + err.message;
        })
        .finally(() => {
          saveBtn.disabled = false;
          setTimeout(() => saveStatus.textContent = '', 3000);
        });
    };

    // ì‹¤ì‹œê°„ ê²°ê³¼ ì—…ë°ì´íŠ¸
    function updateResults() {
      const sorted = reelsData.map(r=>({ ...r, votes: votes[r.id]||0 }))
                              .sort((a,b)=>b.votes - a.votes);
      if (sorted.length === 0) {
        resultsContainer.innerHTML = '<p>ì•„ì§ íˆ¬í‘œê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
      } else {
        resultsContainer.innerHTML = sorted.map((r,i)=>`
          <div class="result-item">
            <span class="result-rank">${i+1}ìœ„</span>
            <span class="result-info">${r.nickname}</span>
            <span class="result-votes">${r.votes}í‘œ</span>
          </div>
        `).join('');
      }
    }

    // ê´€ë¦¬ì ê¸°ëŠ¥ (ê¸°ì¡´ ê·¸ëŒ€ë¡œ)
    document.getElementById('adminLoginBtn').onclick=()=>{
      const id=document.getElementById('adminId').value;
      const pw=document.getElementById('adminPw').value;
      if(id===ADMIN_ID&&pw===ADMIN_PW){
        isAdmin=true;
        document.getElementById('adminLoginModal').style.display='none';
        document.getElementById('clearVotesBtn').style.display='inline-block';
        document.getElementById('logoutAdminBtn').style.display='inline-block';
        alert('ê´€ë¦¬ì ë¡œê·¸ì¸ ì„±ê³µ');
      } else alert('ê´€ë¦¬ì ì¸ì¦ ì‹¤íŒ¨');
    };
    document.getElementById('adminCancelBtn').onclick=()=>{
      document.getElementById('adminLoginModal').style.display='none';
    };
    window.showAdminLogin = ()=>{ if(!isAdmin) document.getElementById('adminLoginModal').style.display='flex'; }
    window.logoutAdmin = ()=>{
      isAdmin=false;
      document.getElementById('clearVotesBtn').style.display='none';
      document.getElementById('logoutAdminBtn').style.display='none';
      alert('ê´€ë¦¬ì ë¡œê·¸ì•„ì›ƒ');
    };
    window.clearAllVotes = ()=>{
      if(!isAdmin) return alert('ê´€ë¦¬ìë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
      reelsData.forEach(r=>{
        set(ref(db, `votes/${r.id}`),0);
        set(ref(db, `captions/${r.id}`),r.caption);
      });
      set(ref(db, `userVotes`), null);
      alert('ì´ˆê¸°í™” ì™„ë£Œ');
    };

    // ì „ì—­ì— ë…¸ì¶œ
    window.renderReels = renderReels;
    window.showFinalResults = ()=>{ document.getElementById('finalResults').style.display='block'; };
  </script>
</body>
</html>
