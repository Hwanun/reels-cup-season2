<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>릴스컵 투표 시스템</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box }
    body { font-family:'Arial',sans-serif; background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); min-height:100vh; color:#333 }
    .login-modal, .admin-login-modal {
      position:fixed; top:0; left:0; width:100%; height:100%;
      background:rgba(0,0,0,0.5); display:flex; align-items:center; justify-content:center;
    }
    .login-content {
      background:#fff; padding:30px; border-radius:15px; width:90%; max-width:400px; text-align:center;
    }
    .login-content h2 { margin-bottom:20px; color:#333 }
    .login-input { width:100%; padding:12px; margin:10px 0; border:1px solid #ddd; border-radius:8px; font-size:1em }
    .login-btn {
      background:#667eea; color:#fff; padding:12px 25px;
      border:none; border-radius:8px; cursor:pointer; font-size:1em; margin:10px 5px
    }
    .login-btn:hover { background:#5a6fd8 }
    .login-btn.cancel { background:#6c757d }
    .login-btn.cancel:hover { background:#5a6268 }
    .container { max-width:1200px; margin:50px auto; padding:20px; background:rgba(255,255,255,0.9); border-radius:15px }
    .header { text-align:center; margin-bottom:30px }
    .header h1 { font-size:2.5em; color:#333 }
    .vote-counter { text-align:center; font-size:1.2em; margin-bottom:20px }
    .reels-grid {
      display:grid; grid-template-columns:repeat(auto-fill,minmax(300px,1fr)); gap:20px; margin-bottom:30px
    }
    .reel-card {
      background:#fff; border-radius:15px; padding:20px; box-shadow:0 8px 32px rgba(0,0,0,0.1);
      display:flex; flex-direction:column; align-items:center
    }
    .reel-nickname { font-size:1.1em; color:#667eea; margin-bottom:12px; font-weight:bold; }
    .reel-video { width:100%; height:300px; border:none; border-radius:10px; margin-bottom:15px }
    .caption-section { width:100%; margin-bottom:15px }
    .reel-caption {
      white-space:pre-wrap; background:rgba(102,126,234,0.1); padding:10px; border-radius:8px; margin-bottom:10px
    }
    .caption-edit textarea {
      width:100%; padding:10px; border:1px solid #ddd; border-radius:5px; resize:vertical; font-size:1em
    }
    .caption-buttons { display:flex; gap:10px; margin-bottom:15px }
    .caption-buttons button {
      flex:1; padding:8px 12px; border:none; border-radius:5px; cursor:pointer; font-size:.9em
    }
    .edit-btn { background:#6c757d; color:#fff }
    .save-btn { background:#28a745; color:#fff }
    .cancel-btn { background:#dc3545; color:#fff }
    .vote-btn {
      width:100%; padding:12px; background:linear-gradient(135deg,#667eea,#764ba2);
      color:#fff; border:none; border-radius:8px; cursor:pointer; font-size:1em; font-weight:bold
    }
    .vote-btn.voted { background:linear-gradient(135deg,#4CAF50,#45a049) }
    .vote-btn:disabled { background:#ccc; cursor:not-allowed }
    .results-section { margin-top:30px }
    .results-section h2 {
      margin-bottom:20px; color:#333; border-bottom:2px solid #667eea; padding-bottom:10px
    }
    .result-item {
      display:flex; justify-content:space-between; padding:15px; margin-bottom:10px;
      background:rgba(102,126,234,0.1); border-radius:8px
    }
    .result-rank { font-size:1.2em; font-weight:bold; color:#667eea }
    .result-info { margin-left:10px; color:#333 }
    .result-votes { font-weight:bold; color:#333 }
    .final-results { display:none; margin-top:30px; text-align:center }
    .final-results h2 { margin-bottom:20px; font-size:2em; color:#333 }
    .winner {
      margin:10px 0; padding:15px; background:rgba(102,126,234,0.2); border-radius:10px; font-size:1.2em
    }
    .admin-controls { text-align:center; margin-bottom:30px }
    .admin-btn, .admin-btn.danger {
      padding:12px 20px; margin:0 5px; border:none; border-radius:8px; cursor:pointer; color:#fff
    }
    .admin-btn { background:#764ba2 }
    .admin-btn.danger { background:#dc3545 }
    .admin-btn:hover { opacity:.9 }
  </style>
</head>
<body>

  <!-- 사용자 로그인 모달 -->
  <div id="userLoginModal" class="login-modal">
    <div class="login-content">
      <h2>릴스컵 사용자 로그인</h2>
      <input id="userName" class="login-input" type="text" placeholder="이름을 입력하세요">
      <button id="userLoginBtn" class="login-btn">입장하기</button>
    </div>
  </div>

  <div class="container" id="appContainer" style="display:none;">
    <div class="header">
      <h1>🏆 릴스컵 투표 시스템</h1>
      <p>최대 5표까지 투표할 수 있습니다.</p>
    </div>

    <div class="vote-counter">
      <span id="voteCount">0</span> / 5 투표 완료
    </div>

    <div class="admin-controls">
      <button class="admin-btn" onclick="showFinalResults()">최종 결과 보기</button>
      <button class="admin-btn" onclick="showAdminLogin()">관리자 로그인</button>
      <button class="admin-btn danger" id="clearVotesBtn" style="display:none;" onclick="clearAllVotes()">모든 투표 초기화</button>
      <button class="admin-btn" id="logoutAdminBtn" style="display:none;" onclick="logoutAdmin()">관리자 로그아웃</button>
    </div>

    <div class="reels-grid" id="reelsGrid"></div>

    <div class="results-section">
      <h2>📊 실시간 투표 결과</h2>
      <div id="resultsContainer"><p>아직 투표가 없습니다.</p></div>
    </div>

    <div class="final-results" id="finalResults">
      <h2>🎉 최종 우승자 TOP 5</h2>
      <div id="winnersContainer"></div>
    </div>
  </div>

  <!-- 관리자 로그인 모달 -->
  <div id="adminLoginModal" class="admin-login-modal" style="display:none;">
    <div class="login-content">
      <h2>🔐 관리자 로그인</h2>
      <input id="adminId" class="login-input" type="text" placeholder="아이디">
      <input id="adminPw" class="login-input" type="password" placeholder="비밀번호">
      <button id="adminLoginBtn" class="login-btn">로그인</button>
      <button id="adminCancelBtn" class="login-btn cancel">취소</button>
    </div>
  </div>

<script type="module">
  // Import the functions you need from the SDKs you need
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
  // TODO: Add SDKs for Firebase products that you want to use
  // https://firebase.google.com/docs/web/setup#available-libraries

  // Your web app's Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyA0B8G1jHsnLkwZC4flHWKM0-6lzdU073E",
    authDomain: "reels-cup2.firebaseapp.com",
    projectId: "reels-cup2",
    storageBucket: "reels-cup2.firebasestorage.app",
    messagingSenderId: "139476452384",
    appId: "1:139476452384:web:553a5b35f4f057db13e845"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);

</script>
    const reelsData = [
      { id:1, url:'https://www.youtube.com/embed/-8dDe_EbKEk', nickname:'호롤롤로', caption:'첫 번째 릴스\n줄넘김 테스트' },
      { id:2, url:'https://www.youtube.com/embed/yahAVfaT5zs', nickname:'핑핑', caption:'두 번째 릴스\n줄넘김 테스트' },
      { id:3, url:'https://www.youtube.com/embed/hNtdL1RtyQY', nickname:'으악', caption:'세 번째 릴스\n줄넘김 테스트' },
      { id:4, url:'https://www.youtube.com/embed/RtWbEDm4GvQ', nickname:'도우너', caption:'네 번째 릴스\n줄넘김 테스트' },
      { id:5, url:'https://www.youtube.com/embed/ZNFc-2Bk86g', nickname:'플래닛성형외과의원', caption:'다섯 번째 릴스\n줄넘김 테스트' },
      { id:6, url:'https://www.youtube.com/embed/VCStJdILfwQ', nickname:'호로롤롤로', caption:'여섯 번째 릴스\n줄넘김 테스트' },
      { id:7, url:'https://www.youtube.com/embed/j5jRH9u583w', nickname:'키키', caption:'일곱 번째 릴스\n줄넘김 테스트' },
      { id:8, url:'https://www.youtube.com/embed/fBfsdIgHW0Q', nickname:'아이고아이고', caption:'여덟 번째 릴스\n줄넘김 테스트' },
      { id:9, url:'https://www.youtube.com/embed/GEOQGCJilYI', nickname:'라임', caption:'아홉 번째 릴스\n줄넘김 테스트' },
      { id:10,url:'https://www.youtube.com/embed/RY60ZC9QyF8', nickname:'힝힝', caption:'열 번째 릴스\n줄넘김 테스트' },
      { id:11,url:'https://www.youtube.com/embed/0Luy2181QMQ', nickname:'삡', caption:'열한 번째 릴스\n줄넘김 테스트' },
      { id:12,url:'https://www.youtube.com/embed/8VDydtUJV5s', nickname:'훌랄라', caption:'열두 번째 릴스\n줄넘김 테스트' },
      { id:13,url:'https://www.youtube.com/embed/fDaON3vG4uI', nickname:'길구몽구봉구', caption:'열세 번째 릴스\n줄넘김 테스트' },
      { id:14,url:'https://www.youtube.com/embed/_qCY3j2RLgs', nickname:'떡순이', caption:'열네 번째 릴스\n줄넘김 테스트' },
      { id:15,url:'https://www.youtube.com/embed/RyVTjCFWHlU', nickname:'쥬라기', caption:'열다섯 번째 릴스\n줄넘김 테스트' }
    ];
    let votes = {}, userVotes = new Set(), currentUser = null, isAdmin=false;
    const MAX_VOTES=5, ADMIN_ID='admin', ADMIN_PW='4321';
    reelsData.forEach(r=>votes[r.id]=0);

    // 사용자 로그인
    document.getElementById('userLoginBtn').onclick = () => {
      const name = document.getElementById('userName').value.trim();
      if (!name) return alert('이름을 입력해주세요.');
      currentUser=name;
      document.getElementById('userLoginModal').style.display='none';
      document.getElementById('appContainer').style.display='block';
      subscribeRealtime();
      renderReels();
      updateResults();
    };

    // Firebase 구독
    function subscribeRealtime() {
      reelsData.forEach(r=>{
        onValue(ref(db, `captions/${r.id}`), snap=>{
          if (snap.exists()) r.caption=snap.val();
          const el=document.getElementById(`caption-${r.id}`);
          if (el) el.textContent=r.caption;
        });
        onValue(ref(db, `votes/${r.id}`), snap=>{
          votes[r.id]=snap.val()||0;
          updateResults();
        });
      });
      onValue(ref(db, `userVotes/${currentUser}`), snap=>{
        userVotes.clear();
        const data=snap.val()||{};
        Object.entries(data).forEach(([k,v])=>{ if (v) userVotes.add(Number(k)); });
        renderReels();
        updateResults();
      });
    }

    // 렌더링
    function renderReels() {
      const grid=document.getElementById('reelsGrid');
      grid.innerHTML=reelsData.map(r=>`
        <div class="reel-card ${userVotes.has(r.id)?'selected':''}" id="card-${r.id}"> 
          <div class="reel-nickname">${r.nickname}</div>
          <iframe class="reel-video" src="${r.url}" allowfullscreen></iframe>
          <div class="caption-section">
            <div class="reel-caption" id="caption-${r.id}">${r.caption}</div>
            <div class="caption-edit" id="edit-${r.id}" style="display:none;">
              <textarea id="input-${r.id}">${r.caption}</textarea>
            </div>
            <div class="caption-buttons">
              <button class="edit-btn" onclick="editCaption(${r.id})">수정</button>
              <button class="save-btn" onclick="saveCaption(${r.id})" style="display:none;">저장</button>
              <button class="cancel-btn" onclick="cancelEdit(${r.id})" style="display:none;">취소</button>
            </div>
          </div>
          <button class="vote-btn ${userVotes.has(r.id)?'voted':''}"
                  onclick="toggleVote(${r.id})"
                  ${userVotes.size>=MAX_VOTES&&!userVotes.has(r.id)?'disabled':''}>
            ${userVotes.has(r.id)?'✓ 투표 완료':'👍 투표하기'}
          </button>
        </div>
      `).join('');
      document.getElementById('voteCount').textContent=userVotes.size;
    }

    // 캡션 편집
    function editCaption(id){
      document.getElementById(`caption-${id}`).style.display='none';
      document.getElementById(`edit-${id}`).style.display='block';
      const b=document.querySelectorAll(`#card-${id} .caption-buttons button`);
      b[0].style.display='none'; b[1].style.display='inline-block'; b[2].style.display='inline-block';
    }
    function saveCaption(id){
      const txt=document.getElementById(`input-${id}`).value.trim();
      if(!txt) return alert('캡션을 입력해주세요.');
      set(ref(db, `captions/${id}`),txt).then(()=>{
        document.getElementById(`caption-${id}`).textContent=txt;
        cancelEdit(id);
      });
    }
    function cancelEdit(id){
      document.getElementById(`edit-${id}`).style.display='none';
      document.getElementById(`caption-${id}`).style.display='block';
      const b=document.querySelectorAll(`#card-${id} .caption-buttons button`);
      b[0].style.display='inline-block'; b[1].style.display='none'; b[2].style.display='none';
    }

    // 투표
    function toggleVote(id){
      const path=ref(db, `userVotes/${currentUser}/${id}`);
      if(userVotes.has(id)){
        set(path,false);
        runTransaction(ref(db, `votes/${id}`),v=> (v||0)-1);
        userVotes.delete(id);
      } else {
        if(userVotes.size>=MAX_VOTES) return alert('최대 5표까지만 투표할 수 있습니다.');
        set(path,true);
        runTransaction(ref(db, `votes/${id}`),v=> (v||0)+1);
        userVotes.add(id);
      }
      renderReels();
      updateResults();
    }

    // 결과 업데이트
    function updateResults(){
      const c=document.getElementById('resultsContainer');
      const sorted=reelsData.map(r=>({...r,votes:votes[r.id]||0})).sort((a,b)=>b.votes-a.votes);
      if(!sorted.length) return c.innerHTML='<p>아직 투표가 없습니다.</p>';
      c.innerHTML=sorted.map((r,i)=>`
        <div class="result-item">
          <span class="result-rank">${i+1}위</span>
          <span class="result-info">${r.nickname}</span>
          <span class="result-votes">${r.votes}표</span>
        </div>
      `).join('');
    }

    // 관리자
    document.getElementById('adminLoginBtn').onclick=()=>{
      const id=document.getElementById('adminId').value;
      const pw=document.getElementById('adminPw').value;
      if(id===ADMIN_ID&&pw===ADMIN_PW){
        isAdmin=true;
        document.getElementById('adminLoginModal').style.display='none';
        document.getElementById('clearVotesBtn').style.display='inline-block';
        document.getElementById('logoutAdminBtn').style.display='inline-block';
        alert('관리자 로그인 성공');
      } else alert('관리자 인증 실패');
    };
    document.getElementById('adminCancelBtn').onclick=()=>{
      document.getElementById('adminLoginModal').style.display='none';
    };
    function showAdminLogin(){ if(!isAdmin) document.getElementById('adminLoginModal').style.display='flex'; }
    function logoutAdmin(){
      isAdmin=false;
      document.getElementById('clearVotesBtn').style.display='none';
      document.getElementById('logoutAdminBtn').style.display='none';
      alert('관리자 로그아웃');
    }
    function clearAllVotes(){
      if(!isAdmin) return alert('관리자만 가능합니다.');
      reelsData.forEach(r=>{
        set(ref(db, `votes/${r.id}`),0);
        set(ref(db, `captions/${r.id}`),r.caption);
      });
      set(ref(db, `userVotes/${currentUser}`),null);
      alert('초기화 완료');
    }

    // 전역 노출
    window.renderReels=renderReels;
    window.toggleVote=toggleVote;
    window.editCaption=editCaption;
    window.saveCaption=saveCaption;
    window.cancelEdit=cancelEdit;
    window.showFinalResults=showFinalResults;
    window.showAdminLogin=showAdminLogin;
    window.logoutAdmin=logoutAdmin;
    window.clearAllVotes=clearAllVotes;
  </script>
</body>
</html>
